# テスト戦略 (Testing Specifications) - ドラフト v2

※ このドキュメントは v1 (IndexedDBのみ) および v2 (Spreadsheet同期) の両方を見据えた戦略です。

## 1. 基本方針
アプリケーションの価値である「データの正確性」と「永続化の信頼性」を最優先事項とする。
特に **「ローカル(Dexie.js)とクラウド(Google Spreadsheet)の同期」** はデータ消失を防ぐ最後の砦であるため、最も重点的にテストを行う。

## 2. 採用ツール (Tool Stack)

### 2.1. ロジック・コンポーネント検証 (Unit/Integration)
*   **Vitest:** 高速な実行環境。計算ロジックや同期ロジックの単体テストに使用。
*   **React Testing Library:** コンポーネントの挙動検証。

### 2.2. E2E / UI検証
*   **Playwright:** ブラウザベースのE2Eテストに使用。PWAとしての動作（オフライン、キャッシュ）や実際のデータ永続化フローを検証する。
*   **Playwright MCP (Model Context Protocol):**
    *   AIエージェントを活用し、自然言語によるテストシナリオの作成・保守を行うことで、E2Eテストのメンテナンスコスト（壊れやすさ）を低減する。
    *   複雑なユーザーフロー（例：「オフラインで記録してオンラインで同期確認」）の検証に活用する。

## 3. テストの階層と範囲

### 3.1. 同期ロジックテスト (Sync Logic Tests) - **[最重要・Critical]**
ローカルキャッシュと外部ストレージの整合性を保証する。
*   **対象:** `src/features/sync/` (同期マネージャー、競合解決ロジック)
*   **検証内容 (Vitest):**
    *   **アップロード:** ローカルの未送信データが正しく抽出され、API形式に変換されるか。
    *   **競合解決:** サーバーとローカルでデータが食い違った場合、定義されたルール（Last Write Wins等）通りに処理されるか。
    *   **エラー処理:** ネットワークエラー時に正しく再試行キューに入るか。

### 3.2. データアクセス層テスト (Local DB) - **[高優先度]**
Dexie.js の動作保証。
*   **対象:** `src/db/`
*   **検証内容 (Vitest):**
    *   IndexedDBへのCRUD操作が正しく行われるか（インメモリDBを使用）。
    *   マイグレーション（スキーマ変更）時に既存データが壊れないか。

### 3.3. E2E / UIテスト (User Flow)
ユーザー体験とシステム全体の結合検証。
*   **ツール:** Playwright (with MCP)
*   **シナリオ例:**
    1.  **通常利用:** 食事を記録 -> アプリ再起動 -> データが残っているか。
    2.  **PWA/オフライン:** 機内モードにする -> 記録する -> 機内モード解除 -> データが同期されるか。
    3.  **UI崩れ:** 各種デバイスサイズ（スマホ、PC）での表示確認。

## 4. データ消失防止のための具体的施策

1.  **同期ロジックの徹底的な単体テスト:**
    *   ネットワーク切断、APIタイムアウト、データ不整合など、あらゆる異常系をモックテストで網羅する。
2.  **実環境に近いE2E:**
    *   Playwrightを使用し、実際のブラウザ環境（Service Workerが動く環境）でデータの保存性を検証する。
3.  **Spreadsheet連携テスト:**
    *   テスト専用のGoogle Spreadsheetを用意し、実際にAPIを叩いて書き込まれることを確認するテストケース（Daily実行など頻度を落として実施）を設ける。