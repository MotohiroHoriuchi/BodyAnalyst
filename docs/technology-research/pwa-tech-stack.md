# PWA (Progressive Web App) 技術スタック解説

## 1. PWAを実現するための構成要素

PWAは単一の技術ではなく、いくつかのウェブ標準技術の組み合わせによって「ネイティブアプリのような体験」を実現する仕組みです。
主に以下の3つの役割を果たす技術（またはライブラリ）が必要になります。

| 役割 | 技術/キーワード | 説明 |
| :--- | :--- | :--- |
| **1. インストール機能** | `Web App Manifest` | アプリ名、アイコン、テーマカラーなどを定義したJSONファイル。これがあると「ホーム画面に追加」が可能になる。 |
| **2. オフライン動作 (ガワ)** | `Service Worker` | ブラウザの裏側で動くプロキシのようなスクリプト。HTML/JS/CSSをキャッシュし、オフライン時にそれらを提供する。 |
| **3. オフライン動作 (データ)** | `IndexedDB` (Dexie.js) | **ここがDexie.jsの出番**。ユーザーの入力データ（筋トレ記録など）を保存する。 |

## 2. Vite環境における主要ライブラリ

BodyAnalyst (Vite + React) において、PWA化を効率的に行うために利用される主要なライブラリは以下の通りです。

### 2.1. vite-plugin-pwa (必須級)
Vite環境におけるPWA開発のデファクトスタンダードです。

*   **何をするもの？**
    *   面倒な `Web App Manifest` ファイルの自動生成。
    *   `Service Worker` のスクリプトの自動生成と登録。
    *   ビルド時にアセット（画像やJSファイル）を自動的にプリキャッシュ対象に含める。
*   **メリット:**
    *   これを入れるだけで、PWAの基礎要件（インストール可能、オフライン起動）の8割が完了します。
    *   開発中はPWA機能を無効化し、本番ビルド時のみ有効化するといった制御が簡単です。

### 2.2. Workbox (vite-plugin-pwa の内部エンジン)
Googleが開発している、Service Workerを簡単に扱うためのライブラリです。`vite-plugin-pwa` の内部で使用されていますが、より高度な設定をする際に意識する必要があります。

*   **何をするもの？**
    *   **キャッシュ戦略の制御:** 「まずはネットワークを見に行き、だめならキャッシュを使う（NetworkFirst）」や「常にキャッシュを使う（CacheFirst）」といった戦略を、リソースの種類ごと（画像、APIレスポンスなど）に定義できます。

## 3. その他の関連ツール・概念

### 3.1. マスク可能なアイコン (Maskable Icon)
PWAとしてインストールされた際、Android等のホーム画面でアイコンが丸く切り抜かれたり、四角く表示されたりしても崩れないようにするための専用アイコン形式。
*   **ツール:** `Maskable.app` などのWebツールを使って、既存のアイコン画像から生成するのが一般的です。

### 3.2. iOS固有の対応 (apple-touch-icon)
PWAの仕様はGoogle主導であるため、Apple (iOS) デバイスでは一部独自の対応が必要です。
*   `apple-touch-icon`: iOSのホーム画面用アイコン設定。`vite-plugin-pwa` の設定で簡単に追加可能です。

## 4. BodyAnalyst における構成図

```mermaid
graph TD
    User[ユーザー]
    subgraph Browser[ブラウザ / 端末]
        UI[画面 (React App)]
        SW[Service Worker (vite-plugin-pwa)]
        Storage[Dexie.js (IndexedDB)]
    end
    Server[Webサーバー / CDN]

    User -- アクセス --> UI
    UI -- データ読み書き --> Storage
    UI -- リソース要求 --> SW
    SW -- キャッシュあれば返す --> UI
    SW -- キャッシュなければ取得 --> Server
```

## 結論
*   データ保存には **Dexie.js** を使いますが、それ以外のPWA機能（インストール、ファイルキャッシュ）には **`vite-plugin-pwa`** を使用するのが最適解です。
*   これらは競合するものではなく、**「データの保存（Dexie）」と「アプリ自体の保存（vite-plugin-pwa）」** という形で協力し合ってPWAを実現します。
