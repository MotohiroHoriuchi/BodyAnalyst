# データ永続化技術の比較と選定 (Persistence Layer Research)

本ドキュメントでは、BodyAnalystにおけるデータ保存技術として、現在採用されている **IndexedDB (Dexie.js)** と、将来的な導入が検討されている **Google Spreadsheet** について比較し、それぞれの特性と役割について解説する。

## 1. 比較対象技術

### 1.1. IndexedDB (with Dexie.js)
ブラウザ標準のNoSQLデータベース。`Dexie.js` はそのラッパーライブラリで、使いやすさを向上させている。
*   **現状:** v1の実装で使用中。
*   **データ保存場所:** ユーザーのブラウザ内部（ローカル）。

### 1.2. Google Spreadsheet (as Backend)
Google Sheets APIを利用し、スプレッドシートを行列データベースとして見立てて利用する方法。
*   **構想:** v2での正式採用候補。
*   **データ保存場所:** クラウド（Google Drive）。

## 2. 特性比較

| 特性 | IndexedDB (Dexie.js) | Google Spreadsheet | 比較・評価 |
| :--- | :--- | :--- | :--- |
| **永続性・信頼性** | △ **環境依存**<br>ブラウザのキャッシュクリア等で消失するリスクがある。 | ◎ **高い**<br>Googleのサーバーに保存され、バージョン履歴も残るため消失リスクは低い。 | データの「絶対的な消失防止」の観点ではSpreadsheetが圧倒的に有利。IndexedDBはあくまで「ローカルキャッシュ」の性質が強い。 |
| **デバイス間同期** | × **不可**<br>PCで記録したデータはスマホで見られない。 | ◎ **可能**<br>アカウントが同じならどの端末からでも同じデータにアクセス可能。 | 複数端末での利用を前提とするなら、クラウドベース（Spreadsheet等）が必須。 |
| **オフライン動作** | ◎ **可能**<br>通信環境がなくても読み書き可能。 | × **不可** (基本)<br>API通信が必要なため、オフラインでは機能しない。 | ジムなど電波が悪い環境での記録にはIndexedDBが有利。 |
| **パフォーマンス** | ◎ **高速**<br>通信が発生しないため、読み書きは一瞬。 | △ **低速**<br>APIリクエスト毎に数百ms〜数秒のラグが発生する可能性がある。 | UIのサクサク感を維持するには工夫が必要（楽観的UI更新など）。 |
| **実装コスト** | ○ **中**<br>非同期処理だが、SQLに近い感覚で扱える。 | △ **高**<br>認証(OAuth)の実装、API制限(Quota)への対処、データ構造の変換が必要。 | Spreadsheet利用は認証周りの実装がハードルとなる。 |
| **リレーショナル** | ○ **対応**<br>Dexieなどのライブラリで結合などが可能。 | △ **不得手**<br>あくまで表計算ソフトであり、複雑なリレーションには向かない。 | 複雑なデータ構造には不向き。 |

## 3. 現状 (v1) における Dexie.js の必要性

現在の v1 において **Dexie.js は「必要」である** と判断できる。理由は以下の通りである。

1.  **バックエンドサーバー不在:** 現在の構成はサーバーレス（クライアントのみ）であるため、データを保存できる場所はブラウザ内部（LocalStorage または IndexedDB）に限られる。
2.  **容量と構造:** LocalStorageは容量制限（約5MB）があり、構造化データの検索に不向き。IndexedDBは容量が大きく、日付検索などが高速に行えるため、ライフログアプリに適している。
3.  **Spreadsheet移行へのつなぎ:** v2でSpreadsheetを採用するとしても、「オフライン時の一次保存場所」や「表示速度向上のためのキャッシュ」としてIndexedDBを併用するアーキテクチャ（Local-First Architecture）が現代的かつ堅牢である。

## 4. v2 (Google Spreadsheet連携) に向けた提言

「IndexedDBかSpreadsheetか」の二者択一ではなく、**「ハイブリッド構成」** が最もユーザー体験が良い。

*   **基本構成:** アプリは常に **Dexie.js (ローカル)** に対して読み書きを行う（爆速、オフライン対応）。
*   **同期処理:** バックグラウンドで定期的に、Dexie.js の内容を Google Spreadsheet にアップロード（同期）する。
*   **メリット:**
    *   ユーザーは通信待ち時間をゼロにできる。
    *   データはクラウドにバックアップされるため、ブラウザデータが消えても復元可能。
    *   v1のコード資産（Dexie.js周り）を無駄にせず、同期ロジックを追加する形で拡張できる。

## 結論
*   v1段階では **Dexie.js は必須** である（他に保存場所がないため）。
*   v2では、Dexie.jsを「キャッシュ兼オフライン用DB」、Spreadsheetを「正のマスターデータ」とする構成を目指すのが合理的である。
