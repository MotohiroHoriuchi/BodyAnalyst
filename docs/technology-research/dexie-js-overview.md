# Dexie.js 技術解説書 (Dexie.js Overview)

## 1. Dexie.js とは何か？

**Dexie.js (デクシー・ジェイエス)** は、Webブラウザに標準搭載されているデータベース **IndexedDB** を、より簡単に、効率的に扱うための **ラッパーライブラリ** です。

### IndexedDB との関係
*   **IndexedDB (標準API):** ブラウザにデータを保存するための強力なデータベースですが、APIが非常に複雑で難解です（「イベントドリブン」でコードが冗長になりがち）。
*   **Dexie.js:** IndexedDBの複雑さを隠蔽し、開発者が直感的に書けるシンプルな命令（メソッド）を提供します。裏側ではIndexedDBを動かしています。

**例え:**
IndexedDBが「エンジンの部品がバラバラに置いてある車庫」だとすれば、Dexie.jsは「ハンドルとアクセルが付いた完成車」です。どちらも同じエンジンで動きますが、運転のしやすさが段違いです。

## 2. なぜ Dexie.js が必要なのか？

IndexedDBを「生（Raw）」で使う場合と比べて、以下のメリットがあるため採用されます。

1.  **コード量の削減:** IndexedDBのネイティブAPIで数十行かかる処理が、Dexie.jsなら数行で書けます。
2.  **Promise / Async-Await 対応:** 最新のJavaScript (TypeScript) の書き方に対応しており、非同期処理（データの読み書き待ち）をきれいに書けます。
3.  **エラーハンドリング:** IndexedDBのエラー処理は複雑ですが、Dexie.jsは分かりやすいエラーメッセージを提供してくれます。
4.  **トランザクション管理:** 「複数のデータを一度に保存し、どれか一つでも失敗したら全部取り消す」といった高度な処理を簡単に実装できます。

## 3. 何ができるのか？（主な機能）

Dexie.js は、リレーショナルデータベース（SQLなど）に近い感覚でブラウザ内のデータを操作できます。

*   **データの保存 (Create):** JavaScriptのオブジェクトをそのまま保存できます。
*   **高速な検索 (Read):** インデックス（索引）を使って、大量のデータから特定の条件（例：日付範囲、カテゴリ）に合うものを高速に検索できます。
*   **一括更新・削除 (Bulk Operations):** 数千件のデータを一度に登録・削除しても高速に動作します。
*   **React との連携:** `useLiveQuery` という機能を使えば、データが変わった瞬間に画面（コンポーネント）を自動的に再描画できます。

## 4. 制限事項・デメリット

Dexie.js 自体の制限というよりは、基盤となっている **IndexedDB (ブラウザ内DB)** の性質による制限です。

1.  **データの永続性 (Persistence):**
    *   ユーザーがブラウザの「閲覧履歴を削除」を実行したり、ディスク容量が不足したりすると、**データがOSによって削除される可能性があります**。
    *   *対策:* あくまで「一時保存」や「キャッシュ」として扱い、重要なデータはクラウド（サーバーやSpreadsheet）にバックアップする必要があります。
2.  **デバイス間同期ができない:**
    *   PCのChromeで保存したデータは、スマホのChromeからは見えません（完全に別物として扱われます）。
3.  **検索能力の限界:**
    *   SQLのような複雑な結合（JOIN）や集計関数は苦手です（できなくはないが、遅いかコードが複雑になる）。単純な検索に向いています。

## 5. 競合ライブラリとの比較

IndexedDBやローカルストレージを扱うライブラリは他にもあります。

| ライブラリ名 | 特徴 | Dexie.js との比較 | 採用の判断基準 |
| :--- | :--- | :--- | :--- |
| **LocalForage** | **最もシンプル**。LocalStorageと同じAPI (`setItem`, `getItem`) でIndexedDBを使える。 | 検索機能（クエリ）がない。キーを指定して1件取得することしかできない。 | 単純な設定値の保存ならLocalForage。検索が必要ならDexie.js。 |
| **RxDB** | **リアルタイム同期特化**。サーバー（CouchDBなど）との自動同期機能を持つ強力なDB。 | 機能が多すぎてサイズが大きく、学習コストが高い。バックエンドの選定も縛られる。 | オフラインファーストでサーバー同期をガッツリやるならRxDB。 |
| **PouchDB** | **CouchDB互換**。老舗のライブラリで同期機能が強力。 | サイズが大きく、動作が少し重い場合がある。 | CouchDBのエコシステムを使うなら選択肢に入る。 |
| **ZangoDB** | MongoDBライクなAPI。 | MongoDBに慣れている人には使いやすいが、メンテナンス頻度やコミュニティ規模はDexie.jsの方が上。 | 好みの問題。 |

## 結論: BodyAnalyst における Dexie.js

BodyAnalyst は「日付範囲でデータを取得する」「グラフ描画のために大量のデータを処理する」といった要件があるため、**検索機能が弱い `LocalForage` では不足** です。
また、現時点では特定のサーバー技術にロックインされたくないため、**汎用性が高く、Reactエコシステムとの相性が良い `Dexie.js` が最適な選択** と言えます。
