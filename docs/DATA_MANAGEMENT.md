# Body Analyst データ管理ドキュメント

## 概要

Body Analystは **100%クライアントサイド** で動作するアプリケーションです。サーバーは静的ファイルの配信のみを行い、ユーザーデータは一切サーバーに送信されません。

```
┌─────────────────────────────────────────────────────────────┐
│                      ユーザーのブラウザ                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Body Analyst                       │   │
│  │  ┌──────────────┐    ┌──────────────────────────┐   │   │
│  │  │   React App  │◀──▶│  IndexedDB               │   │   │
│  │  │              │    │  ・体重記録               │   │   │
│  │  │              │    │  ・食事記録               │   │   │
│  │  │              │    │  ・トレーニング記録       │   │   │
│  │  │              │    │  ・マスタデータ           │   │   │
│  │  │              │    │  ・設定                   │   │   │
│  │  └──────────────┘    └──────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPSで静的ファイル取得のみ
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Webサーバー                             │
│  ・HTML/CSS/JavaScript配信                                  │
│  ・ユーザーデータの送受信なし                                │
│  ・認証なし                                                  │
└─────────────────────────────────────────────────────────────┘
```

## データ保存場所

### ローカル保存（IndexedDB）

すべてのユーザーデータはブラウザの **IndexedDB** に保存されます。

| データ種別 | 保存場所 | 説明 |
|-----------|---------|------|
| 体重記録 | IndexedDB | 日々の体重・体脂肪率 |
| 食事記録 | IndexedDB | 食べたもの・カロリー・PFC |
| トレーニング記録 | IndexedDB | セット・重量・回数・ボリューム |
| 分析ウィンドウ設定 | IndexedDB | グラフ表示設定 |
| 目標設定 | IndexedDB | カロリー・体重目標 |
| ユーザー設定 | IndexedDB | 1RM計算式など |
| 食材マスタ（カスタム） | IndexedDB | ユーザー追加の食材 |
| 種目マスタ（カスタム） | IndexedDB | ユーザー追加の種目 |

### ソースコード内（プリセットデータ）

以下のマスタデータはソースコード（`src/db/seed.ts`）にハードコードされており、アプリ初回起動時にIndexedDBに投入されます。

| データ種別 | 件数 | 説明 |
|-----------|------|------|
| 食材マスタ（プリセット） | 約170件 | 肉・魚・野菜・穀物など |
| 種目マスタ（プリセット） | 28件 | ベンチプレス・スクワットなど |
| デフォルト目標 | 1件 | 初期目標値 |
| デフォルト設定 | 1件 | 初期設定値 |

## データのライフサイクル

### 1. 初期化フロー

```
アプリ起動
    │
    ▼
seedDatabase() 実行
    │
    ├── 食材マスタが空？ ──Yes──▶ プリセット食材170件を投入
    │         │
    │        No（バージョン確認）
    │         │
    │         ▼
    │   バージョンアップ？ ──Yes──▶ プリセット更新（カスタム保持）
    │
    ├── 種目マスタが空？ ──Yes──▶ プリセット種目28件を投入
    │
    ├── 目標設定が空？ ──Yes──▶ デフォルト目標を設定
    │
    └── ユーザー設定が空？ ──Yes──▶ デフォルト設定を設定
```

### 2. データ更新フロー

```
ユーザー操作（例: 体重を入力）
    │
    ▼
Custom Hook（例: useWeightRecords）
    │
    ▼
Dexie.js API（例: db.weightRecords.add()）
    │
    ▼
IndexedDB に保存
    │
    ▼
useLiveQuery によりUIに自動反映
```

### 3. データ削除

```
・個別削除: 各画面のゴミ箱ボタンから
・全削除: ブラウザの「サイトデータを削除」から
```

## データスキーマ詳細

### 体重記録（WeightRecord）

```typescript
{
  id: number;              // 自動採番
  date: string;            // "2024-01-15" 形式
  weight: number;          // kg
  bodyFatPercentage?: number;  // % (オプション)
  muscleMass?: number;     // kg (オプション)
  timing?: 'morning' | 'evening' | 'other';
  memo?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

### 食事記録（MealRecord）

```typescript
{
  id: number;
  date: string;            // "2024-01-15"
  mealType: 'breakfast' | 'lunch' | 'dinner' | 'snack';
  items: [
    {
      foodId: number;      // FoodMasterへの参照
      foodName: string;    // 冗長化（削除対策）
      amount: number;      // グラム
      calories: number;    // 計算済み
      protein: number;
      fat: number;
      carbs: number;
    }
  ];
  totalCalories: number;   // 合計（自動計算）
  totalProtein: number;
  totalFat: number;
  totalCarbs: number;
  createdAt: Date;
  updatedAt: Date;
}
```

### トレーニング記録（WorkoutSession）

```typescript
{
  id: number;
  date: string;
  startTime: Date;
  endTime?: Date;          // 終了時に設定
  exercises: [
    {
      exerciseId: number;  // ExerciseMasterへの参照
      exerciseName: string; // 冗長化
      bodyPart: string;
      sets: [
        {
          setNumber: number;
          weight: number;  // kg
          reps: number;
          rpe?: number;    // 1-10 (オプション)
          isWarmup: boolean;
          completedAt: Date;
        }
      ];
      restTimes: number[]; // 各セット後の休憩秒数
    }
  ];
  totalVolume: number;     // 重量×回数の総和
  createdAt: Date;
  updatedAt: Date;
}
```

### 分析ウィンドウ（AnalyticsWindow）

```typescript
{
  id: number;
  name: string;            // "体重推移" など
  data1: {
    dataType: string;      // 'weight' | 'calories' | etc
    exerciseId?: number;   // 種目系の場合
    exerciseName?: string;
    chartType: 'line' | 'bar';
    color: string;         // "#3B82F6" など
  };
  data2?: { ... };         // オーバーレイ用（オプション）
  periodDays: number;      // 7, 14, 30, 60, 90, 180, 365
  size: '1x1' | '2x1' | '2x2';
  order: number;           // 表示順
  createdAt: Date;
  updatedAt: Date;
}
```

## データの永続性

### 保持される条件

- 同じブラウザ・同じプロファイルを使用
- ブラウザのサイトデータを削除していない
- プライベートモードではない

### 消失する条件

| 操作 | データへの影響 |
|-----|--------------|
| ブラウザを閉じる | **保持される** |
| PCを再起動する | **保持される** |
| ブラウザをアップデート | **保持される** |
| 「閲覧履歴を削除」→「Cookie」のみ | **保持される** |
| 「閲覧履歴を削除」→「サイトデータ」も | **消失する** |
| ブラウザをアンインストール | **消失する** |
| 別のブラウザでアクセス | **別データになる** |
| 別のデバイスでアクセス | **別データになる** |
| シークレットモードでアクセス | **終了時に消失** |

## ストレージ容量

### IndexedDBの制限

| ブラウザ | 制限 |
|---------|------|
| Chrome | ディスク空き容量の60%まで（最大） |
| Firefox | ディスク空き容量の50%まで |
| Safari | 1GBまで（ユーザー許可で拡張可） |

### 想定使用量

```
1年間使用した場合の概算:
・体重記録: 365件 × 約200バイト = 約73KB
・食事記録: 1095件 × 約500バイト = 約548KB
・トレーニング: 156件 × 約2KB = 約312KB
・その他マスタ・設定: 約50KB

合計: 約1MB（1年間）
```

通常の使用では容量が問題になることはありません。

## プライバシーとセキュリティ

### データの所在

```
✅ ユーザーのデバイス内のみ
❌ サーバーに送信されない
❌ クラウドに保存されない
❌ 第三者と共有されない
```

### セキュリティ考慮事項

| 項目 | 状態 | 説明 |
|-----|------|------|
| データ暗号化 | ❌ なし | IndexedDBは平文保存 |
| 認証 | ❌ なし | ログイン不要 |
| 通信暗号化 | ✅ HTTPS | 静的ファイル配信時 |
| XSS対策 | ✅ React | 自動エスケープ |

### 推奨事項

1. **共有デバイスでの使用注意**: 他者がブラウザの開発者ツールからデータを閲覧可能
2. **定期的なバックアップ**: ブラウザデータ削除に備える（※バックアップ機能は今後実装予定）
3. **プライベートモード非推奨**: 終了時にデータが消失

## 将来の拡張計画

### 検討中の機能

1. **エクスポート/インポート**
   - JSON形式でのデータダウンロード
   - バックアップからの復元

2. **クラウド同期（オプション）**
   - アカウント作成によるデバイス間同期
   - 引き続きローカル保存をデフォルトに

3. **データ暗号化**
   - ローカルパスワードによる暗号化オプション

## トラブルシューティング

### データが消えた場合

1. **同じブラウザか確認**: Chrome/Firefox/Safariなど
2. **同じプロファイルか確認**: ブラウザの別プロファイルは別データ
3. **サイトデータ削除していないか**: 設定を確認
4. **復元は不可能**: 現時点ではバックアップからの復元のみ

### データ移行

現時点では自動移行機能はありません。以下の方法で手動移行が可能です：

1. 開発者ツール（F12）→ Application → IndexedDB → BodyAnalystDB
2. 各テーブルのデータをJSON形式でコピー
3. 新環境で開発者コンソールから投入

※正式なエクスポート/インポート機能は今後実装予定
